<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <meta name="theme-color" content="#3367D6"/>
  <link rel="apple-touch-icon" href="/icons-192.png">
  <link rel="manifest" href="/manifest.json">
  
  <meta name="generator" content="Hexo 5.4.0">

  
    <meta name="description" content="å·å·å†™ç‚¹ä¸œè¥¿">
  

  

  
    <meta name="author" content="ReasonLee">
  

  

  

  <title>Androidï¼šHandleræœºåˆ¶ | ReasonLee</title>

  

  
    <link rel="shortcut icon" href="/favicon.ico">
  

  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@1.1.3/index.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlightjs@9.16.2/styles/monokai.css">
  

  
<link rel="stylesheet" href="/css/style.css">

<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --></head>
<body>
  <div class="root-container">
    
<!-- header container -->
<header class="header-container post">
  
    <div class="post-image" style="background-image: url(https://wallpapers.com/images/high/toradora-taiga-aisaka-eating-ithmocq6tsax591p.jpg)"></div>
  

  <!-- navbar -->
<nav class="navbar">
  <div class="navbar-content">
    <!-- logo -->
    <div class="navbar-logo">
      <a href="/">
        
          ReasonLee
        
      </a>
    </div>
    <!-- link -->
    <div class="navbar-link">
      <div class="navbar-btn">
        <div></div>
        <div></div>
        <div></div>
      </div>
      <ul class="navbar-list">
        
          <li class="navbar-list-item"><a href="/">é¦–é¡µ</a></li>
        
          <li class="navbar-list-item"><a href="/links">å‹é“¾</a></li>
        
          <li class="navbar-list-item"><a href="/about">å…³äº</a></li>
        
      </ul>
    </div>
  </div>
</nav>

  
  

  
  

  
  

  
  

  
  
    <div class="header-content">
      <div class="post-text layout-block">
        <div class="layout-margin">
          <h1 class="title-wrap">Androidï¼šHandleræœºåˆ¶</h1>
          <h2 class="title-sub-wrap">
            <strong>ReasonLee</strong>
            <span>å‘å¸ƒäº</span>
            <time  class="article-date" datetime="2022-02-03T11:20:12.000Z" itemprop="datePublished">2022-02-03</time>
          </h2>
          <ul class="wrap-list dark">
  
    <li><a href="/categories/Android%E5%9F%BA%E7%A1%80/">ğŸ“’ AndroidåŸºç¡€</a></li>
  
</ul>
          <ul class="wrap-list dark">
  
    <li><a href="/tags/Handler/">ğŸ·ï¸ Handler</a></li>
  
    <li><a href="/tags/Android%E5%9F%BA%E7%A1%80/">ğŸ·ï¸ AndroidåŸºç¡€</a></li>
  
</ul>
        </div>
      </div>
    </div>
  

  
  
  
</header>

    <!-- æ–‡ç«  -->

<!-- æ–‡ç« å†…å®¹ -->
<div class="body-container">
  <article class="content-container layout-block post-container">
    <div class="article-info">
      
      
      
      
      <section class="article-entry markdown-body layout-margin content-padding--large soft-size--large soft-style--box">
        <h2 id="Handleræœºåˆ¶"><a href="#Handleræœºåˆ¶" class="headerlink" title="Handleræœºåˆ¶"></a>Handleræœºåˆ¶</h2><p><strong>1. ä½œç”¨</strong><br> åœ¨å¤šçº¿ç¨‹çš„åº”ç”¨åœºæ™¯ä¸­ï¼Œå°†å·¥ä½œçº¿ç¨‹ä¸­éœ€æ›´æ–°UIçš„æ“ä½œä¿¡æ¯ ä¼ é€’åˆ° UIä¸»çº¿ç¨‹ï¼Œä»è€Œå®ç° å·¥ä½œçº¿ç¨‹å¯¹UIçš„æ›´æ–°å¤„ç†ï¼Œæœ€ç»ˆå®ç°å¼‚æ­¥æ¶ˆæ¯çš„å¤„ç† ã€‚</p>
<p><img src="https://upload-images.jianshu.io/upload_images/2845137-35ce095f62d20d32.png" alt="img"></p>
<p><strong>2. ä¸ºä»€ä¹ˆè¦ç”¨ Handleræ¶ˆæ¯ä¼ é€’æœºåˆ¶ï¼Ÿ</strong><br> å¤šä¸ªçº¿ç¨‹å¹¶å‘æ›´æ–°UIçš„åŒæ—¶ ä¿è¯çº¿ç¨‹å®‰å…¨ã€‚</p>
<p><strong>3. é‡è¦æ¦‚å¿µ</strong></p>
<p><img src="https://upload-images.jianshu.io/upload_images/2845137-07dda95667b0491e.png" alt="img"></p>
<p><strong>4. å·¥ä½œåŸç†</strong></p>
<p><img src="https://upload-images.jianshu.io/upload_images/2845137-1c0139e979458b14.png" alt="img"></p>
<p><img src="https://upload-images.jianshu.io/upload_images/2845137-bdf21061ce2da0fc.png" alt="img"></p>
<p>çº¿ç¨‹ï¼ˆThreadï¼‰ã€å¾ªç¯å™¨ï¼ˆLooperï¼‰ã€å¤„ç†è€…ï¼ˆHandlerï¼‰ä¹‹é—´çš„å¯¹åº”å…³ç³»å¦‚ä¸‹ï¼š</p>
<ul>
<li>1ä¸ªçº¿ç¨‹ï¼ˆThreadï¼‰åªèƒ½ç»‘å®š 1ä¸ªå¾ªç¯å™¨ï¼ˆLooperï¼‰ï¼Œä½†å¯ä»¥æœ‰å¤šä¸ªå¤„ç†è€…ï¼ˆHandlerï¼‰</li>
<li>1ä¸ªå¾ªç¯å™¨ï¼ˆLooperï¼‰ å¯ç»‘å®šå¤šä¸ªå¤„ç†è€…ï¼ˆHandlerï¼‰</li>
<li>1ä¸ªå¤„ç†è€…ï¼ˆHandlerï¼‰ åªèƒ½ç»‘å®š1ä¸ª1ä¸ªå¾ªç¯å™¨ï¼ˆLooperï¼‰</li>
</ul>
<h2 id="Handleræ˜¯å¦‚ä½•å®ç°å»¶æ—¶æ¶ˆæ¯çš„ï¼Ÿ"><a href="#Handleræ˜¯å¦‚ä½•å®ç°å»¶æ—¶æ¶ˆæ¯çš„ï¼Ÿ" class="headerlink" title="Handleræ˜¯å¦‚ä½•å®ç°å»¶æ—¶æ¶ˆæ¯çš„ï¼Ÿ"></a>Handleræ˜¯å¦‚ä½•å®ç°å»¶æ—¶æ¶ˆæ¯çš„ï¼Ÿ</h2><p>&nbsp;&nbsp;&nbsp;&nbsp;handleræ ¸å¿ƒçš„å‘é€æ¶ˆæ¯çš„æ–¹æ³•æ˜¯sendMessageï¼Œæœ‰çš„æœ‹å‹ä¼šè¯´é‚£postå‘¢ï¼Ÿ<br><br>&nbsp;&nbsp;&nbsp;&nbsp;postçš„è¯å…¶å®ç®—æ˜¯ä¸€ä¸ªhandlerçš„è¯­æ³•ç³–ï¼Œä¼ å…¥runnableåå¸®åŠ©æˆ‘ä»¬æ„å»ºä¸€ä¸ªmessageã€‚<br></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Causes the Runnable r to be added to the message queue.</span><br><span class="hljs-comment">     * The runnable will be run on the thread to which this handler is </span><br><span class="hljs-comment">     * attached. </span><br><span class="hljs-comment">     *  </span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> r The Runnable that will be executed.</span><br><span class="hljs-comment">     * </span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> Returns true if the Runnable was successfully placed in to the </span><br><span class="hljs-comment">     *         message queue.  Returns false on failure, usually because the</span><br><span class="hljs-comment">     *         looper processing the message queue is exiting.</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">post</span><span class="hljs-params">(Runnable r)</span></span><br><span class="hljs-function">    </span>&#123;<br>       <span class="hljs-keyword">return</span>  sendMessageDelayed(getPostMessage(r), <span class="hljs-number">0</span>);<br>    &#125;<br><br><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Message <span class="hljs-title">getPostMessage</span><span class="hljs-params">(Runnable r)</span> </span>&#123;<br>        Message m = Message.obtain();<br>        m.callback = r;<br>        <span class="hljs-keyword">return</span> m;<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°getPostMessageé‡Œå¸®æˆ‘ä»¬æ„å»ºå‡ºä¸€ä¸ªmessageç„¶åå†è°ƒç”¨sendMessageDelayedã€‚</p>
<p>æ¥ä¸‹æ¥çœ‹sendMessageï¼Œç±»ä¼¼äºstartActivityæœ€ç»ˆéƒ½ä¼šèµ°åˆ°startActivityForResultä¸€æ ·ï¼Œhandleræ‰€æœ‰å‘é€æ¶ˆæ¯çš„æ–¹æ³•æœ€ç»ˆéƒ½ä¼šèµ°åˆ°sendMessageDelayedï¼Œåªæ˜¯delayMillisä¸åŒè€Œå·²ï¼Œ<strong>è¿™ä¸ªdelayMilliså°±æ˜¯å»¶æ—¶çš„æ—¶é—´</strong>ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Pushes a message onto the end of the message queue after all pending messages</span><br><span class="hljs-comment">     * before the current time. It will be received in &#123;<span class="hljs-doctag">@link</span> #handleMessage&#125;,</span><br><span class="hljs-comment">     * in the thread attached to this handler.</span><br><span class="hljs-comment">     *  </span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> Returns true if the message was successfully placed in to the </span><br><span class="hljs-comment">     *         message queue.  Returns false on failure, usually because the</span><br><span class="hljs-comment">     *         looper processing the message queue is exiting.</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">sendMessage</span><span class="hljs-params">(Message msg)</span></span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">return</span> sendMessageDelayed(msg, <span class="hljs-number">0</span>);<br>    &#125;<br>    <br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">sendMessageDelayed</span><span class="hljs-params">(Message msg, <span class="hljs-keyword">long</span> delayMillis)</span></span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">if</span> (delayMillis &lt; <span class="hljs-number">0</span>) &#123;<br>            delayMillis = <span class="hljs-number">0</span>;<br>        &#125;<br>        <span class="hljs-keyword">return</span> sendMessageAtTime(msg, SystemClock.uptimeMillis() + delayMillis);<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>ç„¶åè¿™é‡Œä¼šå°†DelayMillisåŠ ä¸Šå½“å‰å¼€æœºçš„æ—¶é—´ï¼ˆè¿™é‡Œå¯ä»¥ç†è§£å°±æ˜¯è¿™ä¸ªtimeå°±æ˜¯ï¼Œç°åœ¨çš„æ—¶é—´+éœ€è¦å»¶è¿Ÿçš„æ—¶é—´=å®é™…æ‰§è¡Œçš„æ—¶é—´ï¼‰ï¼Œæ¥ä¸‹æ¥è¿›åˆ°sendMessageAtTimeæ–¹æ³•é‡Œé¢</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Enqueue a message into the message queue after all pending messages</span><br><span class="hljs-comment">     * before the absolute time (in milliseconds) &lt;var&gt;uptimeMillis&lt;/var&gt;.</span><br><span class="hljs-comment">     * &lt;b&gt;The time-base is &#123;<span class="hljs-doctag">@link</span> android.os.SystemClock#uptimeMillis&#125;.&lt;/b&gt;</span><br><span class="hljs-comment">     * Time spent in deep sleep will add an additional delay to execution.</span><br><span class="hljs-comment">     * You will receive it in &#123;<span class="hljs-doctag">@link</span> #handleMessage&#125;, in the thread attached</span><br><span class="hljs-comment">     * to this handler.</span><br><span class="hljs-comment">     * </span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> uptimeMillis The absolute time at which the message should be</span><br><span class="hljs-comment">     *         delivered, using the</span><br><span class="hljs-comment">     *         &#123;<span class="hljs-doctag">@link</span> android.os.SystemClock#uptimeMillis&#125; time-base.</span><br><span class="hljs-comment">     *         </span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> Returns true if the message was successfully placed in to the </span><br><span class="hljs-comment">     *         message queue.  Returns false on failure, usually because the</span><br><span class="hljs-comment">     *         looper processing the message queue is exiting.  Note that a</span><br><span class="hljs-comment">     *         result of true does not mean the message will be processed -- if</span><br><span class="hljs-comment">     *         the looper is quit before the delivery time of the message</span><br><span class="hljs-comment">     *         occurs then the message will be dropped.</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">sendMessageAtTime</span><span class="hljs-params">(Message msg, <span class="hljs-keyword">long</span> uptimeMillis)</span> </span>&#123;<br>        MessageQueue queue = mQueue;<br>        <span class="hljs-keyword">if</span> (queue == <span class="hljs-keyword">null</span>) &#123;<br>            RuntimeException e = <span class="hljs-keyword">new</span> RuntimeException(<br>                    <span class="hljs-keyword">this</span> + <span class="hljs-string">&quot; sendMessageAtTime() called with no mQueue&quot;</span>);<br>            Log.w(<span class="hljs-string">&quot;Looper&quot;</span>, e.getMessage(), e);<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;<br>        &#125;<br>        <span class="hljs-keyword">return</span> enqueueMessage(queue, msg, uptimeMillis);<br>    &#125;<br>    <br>    <br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">enqueueMessage</span><span class="hljs-params">(MessageQueue queue, Message msg, <span class="hljs-keyword">long</span> uptimeMillis)</span> </span>&#123;<br>        msg.target = <span class="hljs-keyword">this</span>;<br>        <span class="hljs-keyword">if</span> (mAsynchronous) &#123;<br>            msg.setAsynchronous(<span class="hljs-keyword">true</span>);<br>        &#125;<br>        <span class="hljs-keyword">return</span> queue.enqueueMessage(msg, uptimeMillis);<br>    &#125;<br></code></pre></td></tr></table></figure>
<p>å…¶å®åˆ°è¿™é‡Œhandlerçš„ä»»åŠ¡å°±å®Œæˆäº†ï¼ŒæŠŠmessageå‘é€åˆ°messageQueueé‡Œé¢ï¼Œæ¯ä¸ªæ¶ˆæ¯éƒ½ä¼šå¸¦æœ‰ä¸€ä¸ªuptimeMilliså‚æ•°ï¼Œè¿™å°±æ˜¯å»¶æ—¶çš„æ—¶é—´ã€‚<br></p>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹messageQueueé‡Œé¢queue.enqueueMessageè¿™ä¸ªæ–¹æ³•ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs java"><br><span class="hljs-function"><span class="hljs-keyword">boolean</span> <span class="hljs-title">enqueueMessage</span><span class="hljs-params">(Message msg, <span class="hljs-keyword">long</span> when)</span> </span>&#123;<br>       <span class="hljs-keyword">if</span> (msg.target == <span class="hljs-keyword">null</span>) &#123;<br>           <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalArgumentException(<span class="hljs-string">&quot;Message must have a target.&quot;</span>);<br>       &#125;<br>       <span class="hljs-keyword">if</span> (msg.isInUse()) &#123;<br>           <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalStateException(msg + <span class="hljs-string">&quot; This message is already in use.&quot;</span>);<br>       &#125;<br><br>       <span class="hljs-keyword">synchronized</span> (<span class="hljs-keyword">this</span>) &#123;<br>           <span class="hljs-keyword">if</span> (mQuitting) &#123;<br>               IllegalStateException e = <span class="hljs-keyword">new</span> IllegalStateException(<br>                       msg.target + <span class="hljs-string">&quot; sending message to a Handler on a dead thread&quot;</span>);<br>               Log.w(TAG, e.getMessage(), e);<br>               msg.recycle();<br>               <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;<br>           &#125;<br><br>           msg.markInUse();<br>           msg.when = when;<br>           Message p = mMessages;<br>           <span class="hljs-keyword">boolean</span> needWake;<br>           <span class="hljs-keyword">if</span> (p == <span class="hljs-keyword">null</span> || when == <span class="hljs-number">0</span> || when &lt; p.when) &#123;<br>               <span class="hljs-comment">// New head, wake up the event queue if blocked.</span><br>               msg.next = p;<br>               mMessages = msg;<br>               needWake = mBlocked;<br>           &#125; <span class="hljs-keyword">else</span> &#123;<br>               <span class="hljs-comment">// Inserted within the middle of the queue.  Usually we don&#x27;t have to wake</span><br>               <span class="hljs-comment">// up the event queue unless there is a barrier at the head of the queue</span><br>               <span class="hljs-comment">// and the message is the earliest asynchronous message in the queue.</span><br>               needWake = mBlocked &amp;&amp; p.target == <span class="hljs-keyword">null</span> &amp;&amp; msg.isAsynchronous();<br>               Message prev;<br>               <span class="hljs-keyword">for</span> (;;) &#123;<br>                   prev = p;<br>                   p = p.next;<br>                   <span class="hljs-keyword">if</span> (p == <span class="hljs-keyword">null</span> || when &lt; p.when) &#123;<br>                       <span class="hljs-keyword">break</span>;<br>                   &#125;<br>                   <span class="hljs-keyword">if</span> (needWake &amp;&amp; p.isAsynchronous()) &#123;<br>                       needWake = <span class="hljs-keyword">false</span>;<br>                   &#125;<br>               &#125;<br>               msg.next = p; <span class="hljs-comment">// invariant: p == prev.next</span><br>               prev.next = msg;<br>           &#125;<br><br>           <span class="hljs-comment">// We can assume mPtr != 0 because mQuitting is false.</span><br>           <span class="hljs-keyword">if</span> (needWake) &#123;<br>               nativeWake(mPtr);<br>           &#125;<br>       &#125;<br>       <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;<br>   &#125;<br></code></pre></td></tr></table></figure>
<p>é¦–å…ˆæ˜¯è¿›è¡Œmsgçš„ä¸€äº›å±æ€§åˆ¤æ–­ï¼Œhandlerå‘å‡ºçš„targetå€¼ï¼ˆè¿™ä¸ªtargetå€¼å°±æ˜¯handlerè‡ªå·±ï¼‰å¿…é¡»ä¸ä¸ºç©ºï¼Œæ˜¯ä¸ºäº†é€šè¿‡targetå€¼æ¥åˆ¤æ–­æ˜¯å“ªä¸ªhandlerå‘è¿‡æ¥çš„æ¶ˆæ¯çš„ã€‚</p>
<p>&nbsp; &nbsp;<strong>é¡ºä¾¿è¯´ä¸€è¯´ å¹¶ä¸æ˜¯æ‰€æœ‰çš„msgï¼Œtargetå€¼éƒ½å¿…é¡»ä¸ä¸ºç©º</strong><br> <strong>ï¼ˆhandlerçš„åŒæ­¥å±éšœå°±æ˜¯ä¸€ä¸ªtargetä¸ºç©ºçš„msgï¼Œç”¨æ¥ä¼˜å…ˆæ‰§è¡Œå¼‚æ­¥æ–¹æ³•çš„ï¼‰</strong><br>åŒæ­¥å±éšœæœ‰ä¸€ä¸ªå¾ˆé‡è¦çš„ä½¿ç”¨åœºæ‰€å°±æ˜¯æ¥å—å‚ç›´åŒæ­¥Vsyncä¿¡å·ï¼Œç”¨æ¥åˆ·æ–°é¡µé¢viewçš„ã€‚å› ä¸ºä¸ºäº†ä¿è¯viewçš„æµç•…åº¦ï¼Œæ‰€ä»¥æ¯æ¬¡åˆ·æ–°ä¿¡å·åˆ°æ¥çš„æ—¶å€™ï¼Œè¦æŠŠå…¶ä»–çš„ä»»åŠ¡å…ˆæ”¾ä¸€æ”¾ï¼Œä¼˜å…ˆåˆ·æ–°é¡µé¢ã€‚</p>
<p>æ¥ä¸‹æ¥ä¸»è¦å°±æ˜¯å°†è¿™ä¸ªmsgæ ¹æ®å®é™…æ‰§è¡Œæ—¶é—´è¿›è¡Œæ’åºæ’å…¥åˆ°queueé‡Œé¢ï¼ˆçœ‹é‡Œé¢çš„forå¾ªç¯ï¼‰ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">for</span> (;;) &#123;<br>    prev = p;<br>    p = p.next;<br>    <span class="hljs-keyword">if</span> (p == <span class="hljs-keyword">null</span> || when &lt; p.when) &#123;<br>        <span class="hljs-keyword">break</span>;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (needWake &amp;&amp; p.isAsynchronous()) &#123;<br>        needWake = <span class="hljs-keyword">false</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>å¥½äº†ï¼Œç°åœ¨queueä¹Ÿæ„å»ºå®Œæˆäº†ï¼Œå‡è®¾æˆ‘ç°åœ¨ç¬¬ä¸€æ¡æ¶ˆæ¯å°±æ˜¯è¦å»¶è¿Ÿ10ç§’ï¼Œæ€ä¹ˆåŠå‘¢ã€‚å®é™…èµ°ä¸€è¾¹å’¯ã€‚</p>
<p>å‡è®¾æˆ‘ç°åœ¨æ˜¯looperï¼Œæˆ‘è¦éå†è¿™ä¸ªmessageQueueï¼Œé‚£è‚¯å®šè¦è°ƒç”¨nextæ–¹æ³•ã€‚</p>
<p>next()æ–¹æ³•æ¯”è¾ƒé•¿ï¼Œæˆ‘åªè´´å…³äºå»¶æ—¶æ¶ˆæ¯çš„æ ¸å¿ƒéƒ¨åˆ†ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">for</span> (;;) &#123;<br>          <span class="hljs-keyword">if</span> (nextPollTimeoutMillis != <span class="hljs-number">0</span>) &#123;<br>              Binder.flushPendingCommands();<br>          &#125;<br><br>          nativePollOnce(ptr, nextPollTimeoutMillis);<br><br>          <span class="hljs-keyword">synchronized</span> (<span class="hljs-keyword">this</span>) &#123;<br>              <span class="hljs-comment">// Try to retrieve the next message.  Return if found.</span><br>              <span class="hljs-keyword">final</span> <span class="hljs-keyword">long</span> now = SystemClock.uptimeMillis();<br>              Message prevMsg = <span class="hljs-keyword">null</span>;<br>              Message msg = mMessages;<br>              <span class="hljs-keyword">if</span> (msg != <span class="hljs-keyword">null</span> &amp;&amp; msg.target == <span class="hljs-keyword">null</span>) &#123;<br>                  <span class="hljs-comment">// Stalled by a barrier.  Find the next asynchronous message in the queue.</span><br>                  <span class="hljs-keyword">do</span> &#123;<br>                      prevMsg = msg;<br>                      msg = msg.next;<br>                  &#125; <span class="hljs-keyword">while</span> (msg != <span class="hljs-keyword">null</span> &amp;&amp; !msg.isAsynchronous());<br>              &#125;<br>              <span class="hljs-keyword">if</span> (msg != <span class="hljs-keyword">null</span>) &#123;<br>                  <span class="hljs-keyword">if</span> (now &lt; msg.when) &#123;<br>                      <span class="hljs-comment">// Next message is not ready.  Set a timeout to wake up when it is ready.</span><br>                      nextPollTimeoutMillis = (<span class="hljs-keyword">int</span>) Math.min(msg.when - now, Integer.MAX_VALUE);<br>                  &#125;<br>                  â€¦â€¦â€¦â€¦â€¦â€¦ä»¥ä¸‹çœç•¥<br></code></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°è¿™é‡Œä¹Ÿæ˜¯ä¸€ä¸ªforå¾ªç¯éå†é˜Ÿåˆ—ï¼Œæ ¸å¿ƒå˜é‡å°±æ˜¯nextPollTimeoutMillisã€‚å¯ä»¥çœ‹åˆ°ï¼Œè®¡ç®—å‡ºnextPollTimeoutMillisåå°±è°ƒç”¨nativiePollOnceè¿™ä¸ªnativeæ–¹æ³•ã€‚è¿™é‡Œçš„è¯å¤§æ¦‚å¯ä»¥çŒœåˆ°ä»–çš„è¿è¡Œæœºåˆ¶ï¼Œå› ä¸ºä»–æ˜¯æ ¹æ®æ‰§è¡Œæ—¶é—´è¿›è¡Œæ’åºçš„ï¼Œé‚£ä¼ å…¥çš„è¿™ä¸ªnextPollTimeoutMillisåº”è¯¥å°±æ˜¯ä¼‘çœ æ—¶é—´ï¼Œç±»ä¼¼äºjavaçš„sleep(time)ã€‚ä¼‘çœ åˆ°ä¸‹ä¸€æ¬¡messageçš„æ—¶å€™å°±æ‰§è¡Œã€‚é‚£å¦‚æœæˆ‘åœ¨è¿™æ®µæ—¶é—´åˆæ’å…¥äº†ä¸€ä¸ªæ–°çš„messageæ€ä¹ˆåŠï¼Œæ‰€ä»¥handleræ¯æ¬¡æ’å…¥messageéƒ½ä¼šå”¤é†’çº¿ç¨‹ï¼Œé‡æ–°è®¡ç®—æ’å…¥åï¼Œå†èµ°ä¸€æ¬¡è¿™ä¸ªä¼‘çœ æµç¨‹ã€‚</p>
<p>nativiePollOnceè¿™ä¸ªnativeæ–¹æ³•å¯ä»¥é€šè¿‡åå­—çŸ¥é“ï¼Œä»–ç”¨çš„æ˜¯linuxä¸­çš„epollæœºåˆ¶ï¼Œå…·ä½“æ˜¯è°ƒç”¨äº†epoll_waitè¿™ä¸ªæ–¹æ³•ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">epoll_wait</span><span class="hljs-params">(<span class="hljs-keyword">int</span> epfd, struct epoll_event * events, intmaxevents, <span class="hljs-keyword">int</span> timeout)</span></span>;<br></code></pre></td></tr></table></figure>
<p>è¿™ä¸ªepollå’Œselectä¸€æ ·éƒ½æ˜¯linuxçš„ä¸€ä¸ªI/Oå¤šè·¯å¤ç”¨æœºåˆ¶ï¼Œä¸»è¦åŸç†å°±ä¸æ·±å…¥äº†ï¼Œè¿™é‡Œå¤§æ¦‚äº†è§£ä¸€ä¸‹I/Oå¤šè·¯å¤ç”¨æœºåˆ¶å’Œå®ƒä¸Selectçš„åŒºåˆ«å°±è¡Œã€‚</p>
<p><strong>Linuxé‡Œçš„I/Oå¤šè·¯å¤ç”¨æœºåˆ¶</strong>ï¼šä¸¾ä¸ªä¾‹å­å°±æ˜¯æˆ‘ä»¬é’“é±¼çš„æ—¶å€™ï¼Œä¸ºäº†ä¿è¯å¯ä»¥æœ€çŸ­çš„æ—¶é—´é’“åˆ°æœ€å¤šçš„é±¼ï¼Œæˆ‘ä»¬åŒä¸€æ—¶é—´æ‘†æ”¾å¤šä¸ªé±¼ç«¿ï¼ŒåŒæ—¶é’“é±¼ã€‚ç„¶åå“ªä¸ªé±¼ç«¿æœ‰é±¼å„¿å’¬é’©äº†ï¼Œæˆ‘ä»¬å°±æŠŠå“ªä¸ªé±¼ç«¿ä¸Šé¢çš„é±¼é’“èµ·æ¥ã€‚è¿™é‡Œå°±æ˜¯æŠŠè¿™äº›å…¨éƒ¨messageæ”¾åˆ°è¿™ä¸ªæœºåˆ¶é‡Œé¢ï¼Œé‚£ä¸ªtimeåˆ°äº†ï¼Œå°±æ‰§è¡Œé‚£ä¸ªmessageã€‚</p>
<p><strong>epollä¸selectçš„åŒºåˆ«</strong>ï¼šepollè·å–äº‹ä»¶çš„æ—¶å€™é‡‡ç”¨ç©ºé—´æ¢æ—¶é—´çš„æ–¹å¼ï¼Œç±»ä¼¼ä¸äº‹ä»¶é©±åŠ¨ï¼Œæœ‰å“ªä¸ªäº‹ä»¶è¦æ‰§è¡Œï¼Œå°±é€šçŸ¥epollï¼Œæ‰€ä»¥è·å–çš„æ—¶é—´å¤æ‚åº¦æ˜¯Oï¼ˆ1ï¼‰ï¼Œselectçš„è¯åˆ™æ˜¯åªçŸ¥é“æœ‰äº‹ä»¶å‘ç”Ÿäº†ï¼Œè¦é€šè¿‡Oï¼ˆnï¼‰çš„äº‹ä»¶å»è½®è¯¢æ‰¾åˆ°è¿™ä¸ªäº‹ä»¶ã€‚</p>
<h2 id="å…³äº-handlerï¼Œåœ¨ä»»ä½•åœ°æ–¹-new-handler-éƒ½æ˜¯ä»€ä¹ˆçº¿ç¨‹ä¸‹"><a href="#å…³äº-handlerï¼Œåœ¨ä»»ä½•åœ°æ–¹-new-handler-éƒ½æ˜¯ä»€ä¹ˆçº¿ç¨‹ä¸‹" class="headerlink" title="å…³äº handlerï¼Œåœ¨ä»»ä½•åœ°æ–¹ new handler éƒ½æ˜¯ä»€ä¹ˆçº¿ç¨‹ä¸‹"></a><strong>å…³äº handlerï¼Œåœ¨ä»»ä½•åœ°æ–¹ new handler éƒ½æ˜¯ä»€ä¹ˆçº¿ç¨‹ä¸‹</strong></h2><p>1.ä¸ä¼ é€’ Looper åˆ›å»º Handlerï¼š<code>Handler handler = new Handler();</code>ä¸Šæ–‡å°±æ˜¯ Handler æ— å‚åˆ›å»ºçš„æºç ï¼Œå¯ä»¥çœ‹åˆ°æ˜¯é€šè¿‡ <code>Looper.myLooper()</code> æ¥è·å– Looper å¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯è¯´<strong>å¯¹äºä¸ä¼ é€’ Looper å¯¹è±¡çš„æƒ…å†µä¸‹ï¼Œåœ¨å“ªä¸ªçº¿ç¨‹åˆ›å»º Handler é»˜è®¤è·å–çš„å°±æ˜¯è¯¥çº¿ç¨‹çš„ Looper å¯¹è±¡ï¼Œé‚£ä¹ˆ Handler çš„ä¸€ç³»åˆ—æ“ä½œéƒ½æ˜¯åœ¨è¯¥çº¿ç¨‹è¿›è¡Œçš„ã€‚</strong></p>
<p>2.ä¼ é€’ Looper å¯¹è±¡åˆ›å»º Handlerï¼š<code>Handler handler = new Handler(looper);</code>é‚£ä¹ˆçœ‹çœ‹ä¼ å…¥ Looper çš„æ„é€ å‡½æ•°ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Handler</span><span class="hljs-params">(Looper looper)</span> </span>&#123;<br>    <span class="hljs-keyword">this</span>(looper, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">false</span>);<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Handler</span><span class="hljs-params">(Looper looper, Callback callback)</span> </span>&#123;<br>    <span class="hljs-keyword">this</span>(looper, callback, <span class="hljs-keyword">false</span>);<br>&#125;<br><span class="hljs-comment">// ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ looper å¯¹è±¡ï¼Œç¬¬äºŒä¸ª callback å¯¹è±¡ï¼Œç¬¬ä¸‰ä¸ªæ¶ˆæ¯å¤„ç†æ–¹å¼ï¼ˆæ˜¯å¦å¼‚æ­¥ï¼‰</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Handler</span><span class="hljs-params">(Looper looper, Callback callback, <span class="hljs-keyword">boolean</span> async)</span> </span>&#123;<br>    mLooper = looper;<br>    mQueue = looper.mQueue;<br>    mCallback = callback;<br>    mAsynchronous = async;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹å‡ºæ¥ä¼ é€’ Looper å¯¹è±¡ Handler å°±ç›´æ¥ä½¿ç”¨äº†ã€‚æ‰€ä»¥<strong>å¯¹äºä¼ é€’ Looper å¯¹è±¡åˆ›å»º Handler çš„æƒ…å†µä¸‹ï¼Œä¼ é€’çš„ Looper æ˜¯å“ªä¸ªçº¿ç¨‹çš„ï¼ŒHandler ç»‘å®šçš„å°±æ˜¯è¯¥çº¿ç¨‹ã€‚</strong></p>
<h2 id="ä¸ºä»€ä¹ˆåœ¨ä¸»çº¿ç¨‹å¯ä»¥ç›´æ¥ä½¿ç”¨-Handlerï¼Ÿ"><a href="#ä¸ºä»€ä¹ˆåœ¨ä¸»çº¿ç¨‹å¯ä»¥ç›´æ¥ä½¿ç”¨-Handlerï¼Ÿ" class="headerlink" title="ä¸ºä»€ä¹ˆåœ¨ä¸»çº¿ç¨‹å¯ä»¥ç›´æ¥ä½¿ç”¨ Handlerï¼Ÿ"></a><strong>ä¸ºä»€ä¹ˆåœ¨ä¸»çº¿ç¨‹å¯ä»¥ç›´æ¥ä½¿ç”¨ Handlerï¼Ÿ</strong></h2><p>å› ä¸ºä¸»çº¿ç¨‹ä¸­å·²ç»åˆ›å»ºäº† Looper å¯¹è±¡å¹¶å¼€å¯äº†æ¶ˆæ¯å¾ªç¯.</p>
<h2 id="Looper-å¯¹è±¡æ˜¯å¦‚ä½•ç»‘å®š-MessageQueue-çš„ï¼Ÿ"><a href="#Looper-å¯¹è±¡æ˜¯å¦‚ä½•ç»‘å®š-MessageQueue-çš„ï¼Ÿ" class="headerlink" title="Looper å¯¹è±¡æ˜¯å¦‚ä½•ç»‘å®š MessageQueue çš„ï¼Ÿ"></a><strong>Looper å¯¹è±¡æ˜¯å¦‚ä½•ç»‘å®š MessageQueue çš„</strong>ï¼Ÿ</h2><p>Looper æœ‰ä¸ªä¸€æˆå‘˜å˜é‡ mQueueï¼Œå®ƒå°±æ˜¯ Looper å¯¹è±¡é»˜è®¤ä¿å­˜çš„ MessageQueueã€‚</p>
<h2 id="Handler-å¦‚ä½•ç»‘å®š-MessageQueueï¼Ÿ"><a href="#Handler-å¦‚ä½•ç»‘å®š-MessageQueueï¼Ÿ" class="headerlink" title="Handler å¦‚ä½•ç»‘å®š MessageQueueï¼Ÿ"></a><strong>Handler å¦‚ä½•ç»‘å®š MessageQueueï¼Ÿ</strong></h2><p> Handler ç»‘å®šçš„æ˜¯ Looper çš„ MessageQueue å¯¹è±¡ï¼ŒLooper çš„ MessageQueue å¯¹è±¡æ˜¯åœ¨ Looper åˆ›å»ºæ—¶å°± new çš„ã€‚</p>
<h2 id="handlerå‘æ¶ˆæ¯ç»™å­çº¿ç¨‹ï¼Œlooperæ€ä¹ˆå¯åŠ¨ï¼Ÿ"><a href="#handlerå‘æ¶ˆæ¯ç»™å­çº¿ç¨‹ï¼Œlooperæ€ä¹ˆå¯åŠ¨ï¼Ÿ" class="headerlink" title="handlerå‘æ¶ˆæ¯ç»™å­çº¿ç¨‹ï¼Œlooperæ€ä¹ˆå¯åŠ¨ï¼Ÿ"></a>handlerå‘æ¶ˆæ¯ç»™å­çº¿ç¨‹ï¼Œlooperæ€ä¹ˆå¯åŠ¨ï¼Ÿ</h2><p>éœ€è¦åœ¨å­çº¿ç¨‹æ‰‹åŠ¨è°ƒç”¨ï¼Œç„¶åå¯ä»¥æ‰‹åŠ¨ä¼ å…¥looperï¼Œæˆ–è€…é€šè¿‡ThreadLocal.getè·å–å½“å‰å­çº¿ç¨‹çš„looperã€‚</p>
<p>åœ¨æ¯ä¸ªThreadä¸­åŒ…å«ä¸€ä¸ªThreadLocalMapï¼ŒThreadLocalMapçš„keyæ˜¯ThreadLocalçš„å¯¹è±¡ï¼Œvalueæ˜¯ç‹¬äº«æ•°æ®ã€‚</p>
<h2 id="HandlerThread"><a href="#HandlerThread" class="headerlink" title="HandlerThread"></a>HandlerThread</h2><p>HandlerThreadæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªçº¿ç¨‹ç±»ï¼Œå®ƒç»§æ‰¿äº†Threadï¼›<br>HandlerThreadæœ‰è‡ªå·±çš„å†…éƒ¨Looperå¯¹è±¡ï¼Œå¯ä»¥è¿›è¡Œlooperå¾ªç¯ï¼›<br>é€šè¿‡è·å–HandlerThreadçš„looperå¯¹è±¡ä¼ é€’ç»™Handlerå¯¹è±¡ï¼Œå¯ä»¥åœ¨handleMessageæ–¹æ³•ä¸­æ‰§è¡Œå¼‚æ­¥ä»»åŠ¡ã€‚<br>åˆ›å»ºHandlerThreadåå¿…é¡»å…ˆè°ƒç”¨HandlerThread.start()æ–¹æ³•ï¼ŒThreadä¼šå…ˆè°ƒç”¨runæ–¹æ³•ï¼Œåˆ›å»ºLooperå¯¹è±¡ã€‚</p>
<h2 id="Looper"><a href="#Looper" class="headerlink" title="Looper"></a>Looper</h2><p>Looperé€šè¿‡Looper.prepare()åˆ›å»º æœ€ç»ˆä¼š èµ°åˆ° prepareMainLooper()æ–¹æ³•</p>
<p>å¦‚æœå½“å‰çº¿ç¨‹æ²¡æœ‰Looperæ‰ä¼šæ–°å»ºä¸€ä¸ªLooperï¼Œå¦åˆ™æ˜¯é€šè¿‡ThreadLocalæ‹¿ï¼Œåˆ›å»ºLooperçš„æ—¶å€™åŒæ—¶ä¼šæŠŠMessageQueueåˆ›å»ºäº†</p>
<p>looperçš„æ ¸å¿ƒæ–¹æ³•å°±æ˜¯LoopOnce (Loopæ–¹æ³•ç«‹æœ‰ä¸€ä¸ªforæ­»å¾ªç¯ï¼Œé‡Œé¢å°±æ˜¯æ‰§è¡Œè¿™ä¸ª)ã€‚è¿™é‡Œä¼šæŠŠmsgä»msgQueueæ‹¿å‡ºæ¥ï¼Œç„¶åè°ƒç”¨Handlerçš„dispatchMessage -&gt; handleMessage å¤„ç†è¿™ä¸ªMessage.</p>
<p>æ‹¿å‡ºmsgçš„æ–¹æ³•å°±æ˜¯msgQueue.nextæ–¹æ³•ï¼Œè¿™é‡Œä¹Ÿä¼šåˆ¤æ–­nextPollTimeoutMillisï¼Œè¿›è¡Œä¸€ä¸ªæ­»å¾ªç¯ï¼Œå¦‚æœæ­¤æ—¶msgè¿˜æ²¡åˆ°æ—¶é—´ï¼Œåˆ™åˆ·æ–°è¿™ä¸ªæ—¶é—´ï¼Œç„¶åç»§ç»­å¾ªç¯ã€‚å¦‚æœmsgåˆ°æ—¶é—´äº†ï¼Œåˆ™è¿”å›ã€‚</p>
<h2 id="Androidä¸­ä¸ºä»€ä¹ˆä¸»çº¿ç¨‹ä¸ä¼šå› ä¸ºLooper-loop-é‡Œçš„æ­»å¾ªç¯å¡æ­»ï¼Ÿ"><a href="#Androidä¸­ä¸ºä»€ä¹ˆä¸»çº¿ç¨‹ä¸ä¼šå› ä¸ºLooper-loop-é‡Œçš„æ­»å¾ªç¯å¡æ­»ï¼Ÿ" class="headerlink" title="Androidä¸­ä¸ºä»€ä¹ˆä¸»çº¿ç¨‹ä¸ä¼šå› ä¸ºLooper.loop()é‡Œçš„æ­»å¾ªç¯å¡æ­»ï¼Ÿ"></a>Androidä¸­ä¸ºä»€ä¹ˆä¸»çº¿ç¨‹ä¸ä¼šå› ä¸ºLooper.loop()é‡Œçš„æ­»å¾ªç¯å¡æ­»ï¼Ÿ</h2><ol>
<li>ä¸ºè¿™ä¸ªæ­»å¾ªç¯å‡†å¤‡äº†ä¸€ä¸ªæ–°çº¿ç¨‹<br> åœ¨è¿›å…¥æ­»å¾ªç¯ä¹‹å‰ä¾¿åˆ›å»ºäº†æ–°binderçº¿ç¨‹ï¼Œåœ¨ä»£ç ActivityThread.main()ä¸­ï¼š</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span>&#123;<br>        ...<br>        Looper.prepareMainLooper();<br><br>        <span class="hljs-comment">//åˆ›å»ºActivityThreadå¯¹è±¡</span><br>        ActivityThread thread = <span class="hljs-keyword">new</span> ActivityThread();<br><br>        <span class="hljs-comment">//å»ºç«‹Binderé€šé“ (åˆ›å»ºæ–°çº¿ç¨‹)</span><br>        thread.attach(<span class="hljs-keyword">false</span>);<br><br>        <span class="hljs-keyword">if</span>(sMainThreadHandler == <span class="hljs-keyword">null</span>)&#123;<br>           sMainThreadHandler = thread.getHandler();<br>        &#125;<br>        <span class="hljs-comment">// step2: å¼€å§‹å¾ªç¯</span><br>        Loop.loop();<br><br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(<span class="hljs-string">&quot;Main thread loop unexpectedly exited&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>thread.attach(false)ï¼›ä¾¿ä¼šåˆ›å»ºä¸€ä¸ªBinderçº¿ç¨‹ï¼ˆå…·ä½“æ˜¯æŒ‡ApplicationThreadï¼ŒBinderçš„æœåŠ¡ç«¯ï¼Œç”¨äºæ¥æ”¶ç³»ç»ŸæœåŠ¡AMSå‘é€æ¥çš„äº‹ä»¶ï¼‰ï¼Œè¯¥Binderçº¿ç¨‹é€šè¿‡Handlerå°†Messageå‘é€ç»™ä¸»çº¿ç¨‹ã€‚</strong></p>
<h4 id="ä¸»çº¿ç¨‹çš„æ­»å¾ªç¯ä¸€ç›´è¿è¡Œæ˜¯ä¸æ˜¯ç‰¹åˆ«æ¶ˆè€—CPUèµ„æºå‘¢ï¼Ÿ"><a href="#ä¸»çº¿ç¨‹çš„æ­»å¾ªç¯ä¸€ç›´è¿è¡Œæ˜¯ä¸æ˜¯ç‰¹åˆ«æ¶ˆè€—CPUèµ„æºå‘¢ï¼Ÿ" class="headerlink" title="ä¸»çº¿ç¨‹çš„æ­»å¾ªç¯ä¸€ç›´è¿è¡Œæ˜¯ä¸æ˜¯ç‰¹åˆ«æ¶ˆè€—CPUèµ„æºå‘¢ï¼Ÿ"></a>ä¸»çº¿ç¨‹çš„æ­»å¾ªç¯ä¸€ç›´è¿è¡Œæ˜¯ä¸æ˜¯ç‰¹åˆ«æ¶ˆè€—CPUèµ„æºå‘¢ï¼Ÿ</h4><p>å› ä¸ºé‡‡ç”¨çš„æ˜¯epollæœºåˆ¶ï¼Œä»¥ç©ºé—´æ¢æ—¶é—´ï¼Œå¦‚æœmsgæ—¶é—´æ²¡åˆ°çš„è¯ï¼Œçº¿ç¨‹æ˜¯å±äºä¼‘çœ çŠ¶æ€çš„ã€‚</p>
<h4 id="Activityçš„ç”Ÿå‘½å‘¨æœŸæ˜¯æ€ä¹ˆå®ç°åœ¨æ­»å¾ªç¯ä½“å¤–èƒ½å¤Ÿæ‰§è¡Œèµ·æ¥çš„ï¼Ÿ"><a href="#Activityçš„ç”Ÿå‘½å‘¨æœŸæ˜¯æ€ä¹ˆå®ç°åœ¨æ­»å¾ªç¯ä½“å¤–èƒ½å¤Ÿæ‰§è¡Œèµ·æ¥çš„ï¼Ÿ" class="headerlink" title="Activityçš„ç”Ÿå‘½å‘¨æœŸæ˜¯æ€ä¹ˆå®ç°åœ¨æ­»å¾ªç¯ä½“å¤–èƒ½å¤Ÿæ‰§è¡Œèµ·æ¥çš„ï¼Ÿ"></a>Activityçš„ç”Ÿå‘½å‘¨æœŸæ˜¯æ€ä¹ˆå®ç°åœ¨æ­»å¾ªç¯ä½“å¤–èƒ½å¤Ÿæ‰§è¡Œèµ·æ¥çš„ï¼Ÿ</h4><p>ä¸»çº¿ç¨‹åˆ›å»ºäº†ç±» H ç»§æ‰¿äº† Handlerä¸“é—¨æ‰§è¡Œç”Ÿå‘½å‘¨æœŸç­‰æ¶ˆæ¯ï¼Œåœ¨ä¸»çº¿ç¨‹åˆ›å»ºæ—¶å°±åˆ›å»ºäº†è¿™ä¸ª Handler ç”¨äºå¤„ç† Binder çº¿ç¨‹å‘é€æ¥çš„æ¶ˆæ¯ã€‚</p>
<p><strong>Activityçš„ç”Ÿå‘½å‘¨æœŸéƒ½æ˜¯ä¾é ä¸»çº¿ç¨‹çš„Looper.loopï¼Œå½“æ”¶åˆ°ä¸åŒMessageæ—¶åˆ™é‡‡ç”¨ç›¸åº”æªæ–½ï¼š</strong></p>
<p>åœ¨H.handleMessage(msg)æ–¹æ³•ä¸­ï¼Œæ ¹æ®æ¥æ”¶åˆ°ä¸åŒçš„msgï¼Œæ‰§è¡Œç›¸åº”çš„ç”Ÿå‘½å‘¨æœŸã€‚<br> æ¯”å¦‚æ”¶åˆ°msg=H.LAUNCH_ACTIVITYï¼Œåˆ™è°ƒç”¨ActivityThread.handleLaunchActivity()æ–¹æ³•ï¼Œæœ€ç»ˆä¼šé€šè¿‡åå°„æœºåˆ¶ï¼Œåˆ›å»ºActivityå®ä¾‹ï¼Œç„¶åå†æ‰§è¡ŒActivity.onCreate()ç­‰æ–¹æ³•ï¼›<br> å†æ¯”å¦‚æ”¶åˆ°msg=H.PAUSE_ACTIVITYï¼Œåˆ™è°ƒç”¨ActivityThread.handlePauseActivity()æ–¹æ³•ï¼Œæœ€ç»ˆä¼šæ‰§è¡ŒActivity.onPause()ç­‰æ–¹æ³•ã€‚</p>
<h2 id="Handlerå†…å­˜æ³„æ¼çš„é—®é¢˜"><a href="#Handlerå†…å­˜æ³„æ¼çš„é—®é¢˜" class="headerlink" title="Handlerå†…å­˜æ³„æ¼çš„é—®é¢˜"></a>Handlerå†…å­˜æ³„æ¼çš„é—®é¢˜</h2><p>Messageåœ¨æ¶ˆæ¯é˜Ÿåˆ—ä¸­å»¶æ—¶äº†Nåˆ†é’Ÿï¼Œç„¶åæ‰å¤„ç†è¯¥æ¶ˆæ¯ã€‚è€Œè¿™ä¸ªæ¶ˆæ¯å¼•ç”¨äº†Handlerå¯¹è±¡ï¼ŒHandlerå¯¹è±¡åˆéšæ€§åœ°æŒæœ‰äº†Activityçš„å¯¹è±¡ï¼Œå½“å‘ç”ŸGCæ˜¯ä»¥ä¸º message â€“ handler â€“ acitivity çš„å¼•ç”¨é“¾å¯¼è‡´Activityæ— æ³•è¢«å›æ”¶ï¼Œæ‰€ä»¥å‘ç”Ÿäº†å†…å­˜æ³„éœ²çš„é—®é¢˜ã€‚</p>
<h3 id="è§£å†³ï¼š"><a href="#è§£å†³ï¼š" class="headerlink" title="è§£å†³ï¼š"></a>è§£å†³ï¼š</h3><ul>
<li><strong>ä½¿ç”¨å¼±å¼•ç”¨ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠ Handler å¯¹ Activity å¼±å¼•ç”¨ï¼Œè¿™æ · GC å°±èƒ½æŠŠ Activity åŠæ—¶çš„å›æ”¶</strong></li>
<li><strong>åŠæ—¶æ¸…é™¤æ¶ˆæ¯ï¼Œæˆ‘ä»¬å¯ä»¥å°è¯•åœ¨å½“å‰ç•Œé¢ç»“æŸæ—¶å°†æ¶ˆæ¯é˜Ÿåˆ—ä¸­æœªè¢«å¤„ç†çš„æ¶ˆæ¯æ¸…é™¤ï¼Œä»æºå¤´ä¸Šè§£é™¤äº†è¿™æ¡å¼•ç”¨é“¾ï¼Œä»è€Œä½¿ Activity èƒ½è¢«åŠæ—¶çš„å›æ”¶ã€‚</strong></li>
</ul>
<h2 id="Handler-Nativeå±‚"><a href="#Handler-Nativeå±‚" class="headerlink" title="Handler (Nativeå±‚)"></a>Handler (Nativeå±‚)</h2><p>Native çš„ Looper é¦–å…ˆä¼šé€šè¿‡ <a target="_blank" rel="noopener" href="https://blog.csdn.net/lsh_sh/article/details/106111426">eventfd()</a>å‡½æ•°åˆ›å»ºä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œå°±æ˜¯åˆ›å»ºä¸€ä¸ªç®¡é“äº†ï¼Œç„¶åè°ƒç”¨rebuildEpollLocked()</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Looper::rebuildEpollLocked</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-comment">// å¦‚æœæœ‰æ—§çš„ç®¡é“å­˜åœ¨ï¼Œåˆ™å…³é—­</span><br>    <span class="hljs-keyword">if</span> (mEpollFd &gt;= <span class="hljs-number">0</span>) &#123;<br><span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> DEBUG_CALLBACKS</span><br>        <span class="hljs-built_in">ALOGD</span>(<span class="hljs-string">&quot;%p ~ rebuildEpollLocked - rebuilding epoll set&quot;</span>, <span class="hljs-keyword">this</span>);<br><span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span><br>        <span class="hljs-built_in">close</span>(mEpollFd);<br>    &#125;<br><br>    <span class="hljs-comment">// å¼€å§‹æ ¹æ®epollæœºåˆ¶åˆ›å»ºæ–‡ä»¶ç›‘å¬ </span><br>    mEpollFd = <span class="hljs-built_in">epoll_create</span>(EPOLL_SIZE_HINT);<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">epoll_event</span> <span class="hljs-title">eventItem</span>;</span><br>    <span class="hljs-built_in">memset</span>(&amp; eventItem, <span class="hljs-number">0</span>, <span class="hljs-built_in"><span class="hljs-keyword">sizeof</span></span>(epoll_event)); <span class="hljs-comment">// zero out unused members of data field union</span><br>    eventItem.events = EPOLLIN;<br>    eventItem.data.fd = mWakeEventFd;<br>    <span class="hljs-comment">//è¿™ä¸ªå‡½æ•°å°±æ˜¯åˆ›å»ºç›‘å¬äº†</span><br>    <span class="hljs-keyword">int</span> result = <span class="hljs-built_in">epoll_ctl</span>(mEpollFd, EPOLL_CTL_ADD, mWakeEventFd, &amp; eventItem);<br><br><br>    <span class="hljs-comment">// è¿™ä¸ªforå¾ªç¯ä¹Ÿæ˜¯ä¸€æ ·æ³¨å†Œç›‘å¬ï¼Œä¸è¿‡ç¬¬ä¸€æ¬¡è¿›æ¥mRequests è‚¯å®šæ²¡å€¼ï¼Œæ‰€æœ‰ä¸èµ°è¿™é‡Œï¼Œä½ç‰ˆæœ¬å‹æ ¹æ²¡è¿™ä¸ªfor</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">size_t</span> i = <span class="hljs-number">0</span>; i &lt; mRequests.<span class="hljs-built_in">size</span>(); i++) &#123;<br>        <span class="hljs-keyword">const</span> Request&amp; request = mRequests.<span class="hljs-built_in">valueAt</span>(i);<br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">epoll_event</span> <span class="hljs-title">eventItem</span>;</span><br>        request.<span class="hljs-built_in">initEventItem</span>(&amp;eventItem);<br>    <br>        <span class="hljs-keyword">int</span> epollResult = <span class="hljs-built_in">epoll_ctl</span>(mEpollFd, EPOLL_CTL_ADD, request.fd, &amp; eventItem);<br>        <span class="hljs-keyword">if</span> (epollResult &lt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-built_in">ALOGE</span>(<span class="hljs-string">&quot;Error adding epoll events for fd %d while rebuilding epoll set: %s&quot;</span>,<br>                  request.fd, <span class="hljs-built_in">strerror</span>(errno));<br>        &#125;<br>    &#125;<br><br>&#125;<br><br><br></code></pre></td></tr></table></figure>

<p>rebuildEpollLocked ä¸»è¦åŠŸèƒ½å°±æ˜¯é€šè¿‡ Linuxçš„epollæœºåˆ¶æ¥åˆ›å»ºæ–‡ä»¶ç›‘å¬ï¼›ä½œç”¨æ˜¯ç›‘å¬mWakeEventFd è¿™ä¸ªæ–‡ä»¶æè¿°ç¬¦çš„EPOLLIN äº‹ä»¶ï¼Œæ—¢ç®¡é“å†…æœ‰å†…å®¹å¯è¯»çš„æ—¶å€™ï¼Œç®¡é“è¯»å–ç«¯ä¼šè¢«å”¤é†’ï¼ŒLooperçš„åˆå§‹åŒ–åˆ°æ­¤ç»“æŸã€‚Looperåˆå§‹åŒ–çš„å·¥ä½œæœ‰ï¼š</p>
<p>é€šè¿‡android_os_MessageQueue.cpp æ–‡ä»¶åˆ›å»ºNativeMessageQueueå¯¹è±¡å¹¶è¿”å›ç»™javaå±‚ï¼›<br>NativeMessageQueue æ„é€ å‡½æ•°åˆ›å»ºLooperå¯¹è±¡å¹¶ä¿å­˜èµ·æ¥ï¼›<br>Looperæ„é€ å‡½æ•°å†…é€šè¿‡ eventfd() å‡½æ•°åˆ›å»ºä¸€ä¸ªç®¡é“ï¼Œå¹¶é€šè¿‡epoll æœºåˆ¶å¯¹ç®¡é“çš„EPOLLIN äº‹ä»¶è¿›è¡Œç›‘å¬ï¼›</p>
<p>JAVAå±‚Looper çš„ queue.next()ä¼šè°ƒç”¨</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function">Message <span class="hljs-title">next</span><span class="hljs-params">()</span></span>&#123;<br>    ...<br>    <span class="hljs-keyword">for</span>(;;)&#123;<br>        ...<br>            nativePollOnce(ptr, nextPollTimeoutMillis);<br>        ...<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>





<p>æœ€ååˆ°Nativeå±‚ä¼šè°ƒç”¨åˆ° pollInner(int timeoutMillis)æ–¹æ³•</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><code class="hljs c++"><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">Looper::pollInner</span><span class="hljs-params">(<span class="hljs-keyword">int</span> timeoutMillis)</span> </span>&#123;<br><span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> DEBUG_POLL_AND_WAKE</span><br>    <span class="hljs-built_in">ALOGD</span>(<span class="hljs-string">&quot;%p ~ pollOnce - waiting: timeoutMillis=%d&quot;</span>, <span class="hljs-keyword">this</span>, timeoutMillis);<br><span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span><br><br>    <span class="hljs-comment">// timeoutMillis != 0 æ—¶ï¼Œè°ƒæ•´ä¸€ä¸‹timeoutMillisçš„æ—¶é—´ï¼ŒtimeoutMillisçš„å€¼ä¸º0 åˆ™ä¸èµ°è¿™é‡Œ</span><br>    <span class="hljs-keyword">if</span> (timeoutMillis != <span class="hljs-number">0</span> &amp;&amp; mNextMessageUptime != LLONG_MAX) &#123;<br>        <span class="hljs-keyword">nsecs_t</span> now = <span class="hljs-built_in">systemTime</span>(SYSTEM_TIME_MONOTONIC);<br>        <span class="hljs-keyword">int</span> messageTimeoutMillis = <span class="hljs-built_in">toMillisecondTimeoutDelay</span>(now, mNextMessageUptime);<br>        <span class="hljs-keyword">if</span> (messageTimeoutMillis &gt;= <span class="hljs-number">0</span><br>                &amp;&amp; (timeoutMillis &lt; <span class="hljs-number">0</span> || messageTimeoutMillis &lt; timeoutMillis)) &#123;<br>            timeoutMillis = messageTimeoutMillis;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">// Poll.</span><br>    <span class="hljs-keyword">int</span> result = POLL_WAKE;<span class="hljs-comment">//POLL_WAKEçš„å€¼ä¸º-1</span><br>    mResponses.<span class="hljs-built_in">clear</span>();<br>    mResponseIndex = <span class="hljs-number">0</span>;<br>    mPolling = <span class="hljs-literal">true</span>;<br><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">epoll_event</span> <span class="hljs-title">eventItems</span>[<span class="hljs-title">EPOLL_MAX_EVENTS</span>];</span><br>    <span class="hljs-comment">//è¯¥å‡½æ•°è¿”å›éœ€è¦å¤„ç†çš„äº‹ä»¶æ•°ç›®ï¼Œå¦‚è¿”å›0è¡¨ç¤ºå·²è¶…æ—¶ã€‚</span><br>    <span class="hljs-comment">//è¿™æ˜¯ä¸ªéå¸¸é‡è¦çš„å‡½æ•°ï¼Œæ‰€ä»¥è¯´éœ€è¦å…ˆå»äº†è§£epollæœºåˆ¶ï¼Œ</span><br>    <span class="hljs-comment">//mEpollFd å°±æ˜¯epoll_create åˆ›å»ºçš„æ–‡ä»¶æè¿°ç¬¦</span><br>    <span class="hljs-comment">//eventItems å¤„ç†çš„äº‹ä»¶ç»“æœå­˜æ”¾çš„åœ°æ–¹</span><br>    <span class="hljs-comment">//EPOLL_MAX_EVENTS  æœ€å¤§çš„å¤„ç†æ•°é‡</span><br>    <span class="hljs-comment">//timeoutMillis è¶…æ—¶æ—¶é—´ï¼Œ0åˆ™æ˜¯ç«‹å³è¿”å›ï¼Œ-1 åˆ™æ˜¯ä¸€ç›´é˜»å¡ç­‰å¾…ï¼Œç­‰å¾…è¢«å”¤é†’</span><br>    <span class="hljs-keyword">int</span> eventCount = <span class="hljs-built_in">epoll_wait</span>(mEpollFd, eventItems, EPOLL_MAX_EVENTS, timeoutMillis);<br><br>    mPolling = <span class="hljs-literal">false</span>;<br>    mLock.<span class="hljs-built_in">lock</span>();<br><br>    <span class="hljs-comment">// æ˜¯å¦é‡æ–°åˆå§‹åŒ–ï¼Œé‡Œé¢è°ƒç”¨äº†rebuildEpollLocked()ï¼Œä¸Šé¢åˆ†æçš„Looperåˆå§‹åŒ–Looperçš„æ„é€ å‡½æ•°ä¹Ÿæ˜¯è°ƒç”¨rebuildEpollLocked()</span><br>    <span class="hljs-comment">//ä¸€èˆ¬æƒ…å†µä¸éœ€è¦é‡æ–°åˆå§‹åŒ–</span><br>    <span class="hljs-keyword">if</span> (mEpollRebuildRequired) &#123;<br>        mEpollRebuildRequired = <span class="hljs-literal">false</span>;<br>        <span class="hljs-built_in">rebuildEpollLocked</span>();<br>        <span class="hljs-keyword">goto</span> Done;<br>    &#125;<br><br>    <span class="hljs-comment">//éœ€è¦å¤„ç†çš„äº‹ä»¶æ•°ç›®å°äº0ï¼Œè¿”å›</span><br>    <span class="hljs-keyword">if</span> (eventCount &lt; <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-keyword">if</span> (errno == EINTR) &#123;<br>            <span class="hljs-keyword">goto</span> Done;<br>        &#125;<br>        result = POLL_ERROR;<br>        <span class="hljs-keyword">goto</span> Done;<br>    &#125;<br><br>    <span class="hljs-comment">// è¶…æ—¶ä¹Ÿç›´æ¥è¿”å›</span><br>    <span class="hljs-keyword">if</span> (eventCount == <span class="hljs-number">0</span>) &#123;<br>        result = POLL_TIMEOUT;<br>        <span class="hljs-keyword">goto</span> Done;<br>    &#125;<br>    <span class="hljs-comment">//å¦‚æœæœ‰äº‹ä»¶è¿”å›ï¼Œå°±è¯´æ˜ç®¡é“ä¸­æœ‰å†…å®¹ï¼Œåˆ™è°ƒç”¨ awoken() å‡½æ•°ä¹‹åè¿”å›</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; eventCount; i++) &#123;<br>        <span class="hljs-keyword">int</span> fd = eventItems[i].data.fd;<br>        <span class="hljs-keyword">uint32_t</span> epollEvents = eventItems[i].events;<br>        <span class="hljs-keyword">if</span> (fd == mWakeEventFd) &#123;<span class="hljs-comment">//mWakeEventFd æ˜¯Looper æ„é€ å‡½æ•°ä¸­åˆ›å»ºçš„æ–‡ä»¶æè¿°ç¬¦ï¼Œå°±æ˜¯ç®¡é“</span><br>            <span class="hljs-keyword">if</span> (epollEvents &amp; EPOLLIN) &#123;<span class="hljs-comment">//åˆ¤æ–­äº‹ä»¶æ˜¯å¦æ˜¯EPOLLINäº‹ä»¶</span><br>                <span class="hljs-built_in">awoken</span>();<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>               <br>            &#125;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>           ...<br>        &#125;<br>    &#125;<br>Done: ;<br>    <span class="hljs-comment">//è¿™é‡Œçš„ä»£ç å¾ˆå¤šï¼Œå…¶å®å°±æ˜¯åšä¸€ä¸‹æ¸…é™¤æ“ä½œ</span><br>  .<br>    .<br>    .<br>    <span class="hljs-keyword">return</span> result;<br>&#125;<br><span class="hljs-comment">// result çš„ç»“æœå°±æ˜¯ä¸‹é¢çš„å››ä¸ªæšä¸¾å€¼</span><br><span class="hljs-class"><span class="hljs-keyword">enum</span> &#123;</span><br>        POLL_WAKE = <span class="hljs-number">-1</span>,<br>        POLL_CALLBACK = <span class="hljs-number">-2</span>ï¼Œ<br>        POLL_TIMEOUT = <span class="hljs-number">-3</span>,<br>        POLL_ERROR = <span class="hljs-number">-4</span>,<br>    &#125;;<br></code></pre></td></tr></table></figure>

<p>å½“æ²¡æœ‰æ¶ˆæ¯çš„æ—¶å€™timeoutMillis = -1ï¼Œepoll_wait() å‡½æ•°åˆ™ä¼šå¤„äºé˜»å¡çŠ¶æ€ï¼Œåœ¨è¿™é‡Œï¼Œepoll_waitæ–¹æ³•ä¼šå¾—åˆ°ä¸€æ®µæ—¶é—´å†…æ”¶åˆ°çš„äº‹ä»¶ä¸ªæ•°ï¼Œæ­¤æ—¶çš„queueæ˜¯ç©ºé—²ï¼ˆé˜»å¡ï¼‰çš„çŠ¶æ€çš„ã€‚ç„¶åå¦‚æœäº‹ä»¶æ•°ä¸ä¸º0ï¼Œéå†æ‰€æœ‰äº‹ä»¶ï¼Œçœ‹çœ‹æœ‰æ²¡æœ‰mWakeEventFdï¼ˆè¿™é‡Œç”¨åˆ°äº†eventfd æ˜¯ä¸€ç§IPCé€šä¿¡æ–¹å¼ï¼Œä¸»è¦ç”¨æ¥åšäº‹ä»¶é€šçŸ¥ï¼Œæ¯”pipeé«˜æ•ˆï¼ŒLooperçš„å”¤é†’ä¹Ÿä»pipeå˜æˆäº†eventfdã€‚ï¼‰ï¼Œè€Œä¸”æ˜¯EPOLLINäº‹ä»¶ï¼Œæœ‰çš„è¯å°±çœŸæ­£å”¤é†’çº¿ç¨‹ï¼Œè§£é™¤ç©ºé—²çŠ¶æ€ã€‚è¿™é‡Œå¦‚æœéœ€è¦å”¤é†’çº¿ç¨‹ï¼Œeventfdä¼šä¼ å…¥é€šçŸ¥æ¶ˆæ¯ï¼Œåˆ™æ­¤æ—¶çš„äº‹ä»¶å°±æˆäº†mWakeEventFdï¼Œæ‰€ä»¥éœ€è¦å”¤é†’ã€‚</p>
<p>å‡½æ•°å†…é€šè¿‡ epollæœºåˆ¶çš„epoll_wait() å‡½æ•°æ¥è¿›è¡Œçº¿ç¨‹çš„é˜»å¡å’Œè¶…æ—¶è°ƒèµ·ï¼›</p>
<p>å½“epoll_wait() è¿”å›ï¼ŒeventCount å°äºç­‰äº0 è¯´æ˜æ²¡æœ‰äº‹ä»¶ï¼Œä½¿ç”¨gotoè¿”å›ï¼Œè¿”å›çš„ result çš„å€¼éƒ½å°äº0<br>å½“epoll_wait() è¿”å›ï¼ŒeventCountå¤§äº0åˆ™è¯´æ˜æœ‰äº‹ä»¶ï¼Œåˆ¤æ–­äº‹ä»¶æ˜¯å¦ä¸ºEPOLLINäº‹ä»¶ï¼Œæ˜¯åˆ™è°ƒåˆ° awoken() å‡½æ•°</p>
<p>å”¤é†’å°±æ˜¯å¾€ç®¡é“ä¸­å†™å…¥å†…å®¹ï¼Œå‰é¢è¯´äº†é€šè¿‡epoll_ctl() å‡½æ•°å¯¹ç®¡é“æ³¨å†Œäº†ç›‘å¬ï¼Œå½“æœ‰å†…å®¹å¾€ç®¡é“å†™æ—¶ï¼Œepoll_wait() å‡½æ•°å°±ä¼šè¢«å”¤é†’ï¼Œå”¤é†’çš„æµç¨‹å°±æ˜¯è¿™ä¹ˆç®€å•ã€‚</p>
<h4 id="epoll-wait"><a href="#epoll-wait" class="headerlink" title="epoll_wait"></a>epoll_wait</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">epoll_wait</span><span class="hljs-params">(<span class="hljs-keyword">int</span> epfd, struct epoll_event * events, <span class="hljs-keyword">int</span> maxevents, <span class="hljs-keyword">int</span> timeout)</span></span>;<br></code></pre></td></tr></table></figure>


<p><strong>å‡½æ•°ä½œç”¨</strong>ï¼šç­‰å¾…ä¸€å®šæ—¶é—´å†…äº‹ä»¶çš„äº§ç”Ÿ(è½®è¯¢)<br><strong>å‚æ•°</strong>ï¼š<br>epfdï¼šç”±epoll_create ç”Ÿæˆçš„epollä¸“ç”¨çš„æ–‡ä»¶æè¿°ç¬¦ï¼›<br>epoll_eventï¼šç”¨äºå›ä¼ ä»£å¤„ç†äº‹ä»¶çš„æ•°ç»„ï¼›<br>maxeventsï¼šæ¯æ¬¡èƒ½å¤„ç†çš„äº‹ä»¶æ•°ï¼›<br>timeoutï¼šç­‰å¾…I/Oäº‹ä»¶å‘ç”Ÿçš„è¶…æ—¶å€¼ã€‚-1ç›¸å½“äºé˜»å¡ï¼Œ0ç›¸å½“äºéé˜»å¡ã€‚ä¸€èˆ¬ä½¿ç”¨-1ï¼›<br>è¿”å›ï¼šå‘ç”Ÿçš„äº‹ä»¶æ•°</p>

      </section>

      
      
        <nav class="article-nav">
          
            <div class="article-nav-item layout-padding">
  <article class="card-container article-nav-card content-padding--primary soft-size--large soft-style--box">
    
    <div class="card-text">
      
        <a href="/2022/02/061920.html" itemprop="url">
          <h2 class="card-text--title text-ellipsis">Androidï¼šActivity</h2>
        </a>
      
      <div class="card-text--row">Newer</div>
    </div>
  </article>
</div>
          
          
            <div class="article-nav-item layout-padding">
  <article class="card-container article-nav-card content-padding--primary soft-size--large soft-style--box">
    
    <div class="card-text">
      
        <a href="/2022/02/030920.html" itemprop="url">
          <h2 class="card-text--title text-ellipsis">JVMï¼šCMSå’ŒG1çš„åŒºåˆ«</h2>
        </a>
      
      <div class="card-text--row">Older</div>
    </div>
  </article>
</div>
          
        </nav>
      

      <section class="page-message-container layout-padding">
        


  
  

  
  


      </section>
    </div>
    <div class="widget-info">
      <section class="widget-author widget-item layout-margin content-padding--primary soft-size--large soft-style--box">
  <div class="widget-body">
    
      <img src="https://img2.baidu.com/it/u=306228493,3347220292&amp;fm=26&amp;fmt=auto&amp;gp=0.jpg" class="soft-size--round soft-style--box" alt="Yusen">
    
    
      <h2>Yusen</h2>
    
    
      <p>æƒ¹å•Š</p>
    

    <div class="count-box">
      <div class="count-box--item">
        <svg class="icon icon-article" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
  <path d="M240.51564747 647.74217627h196.07203239c16.59071043 0 30.16492806-13.57421762 30.16492805-30.16492806V165.10332731c0-33.18142087-30.16492806-60.32985613-60.32985612-60.32985611H245.04038668C225.43318342 104.7734712 210.35071939 119.85593522 210.35071939 139.46313845V617.57724821c0 16.59071043 13.57421762 30.16492806 30.16492808 30.16492806z m663.62841731-452.47392089v482.63884894c0 33.18142087-27.14843525 60.32985613-60.32985612 60.32985613H180.18579134c-33.18142087 0-60.32985613-27.14843525-60.32985612-60.32985613V195.26825538c-49.77213131 0-90.49478418 40.72265287-90.49478417 90.49478417v452.4739209c0 49.77213131 40.72265287 90.49478418 90.49478417 90.49478417h286.56681657c16.59071043 0 30.16492806 13.57421762 30.16492807 30.16492807s13.57421762 30.16492806 30.16492805 30.16492806h90.49478418c16.59071043 0 30.16492806-13.57421762 30.16492805-30.16492806s13.57421762-30.16492806 30.16492807-30.16492807h286.56681657c49.77213131 0 90.49478418-40.72265287 90.49478417-90.49478417V285.76303955c0-49.77213131-40.72265287-90.49478418-90.49478417-90.49478417zM587.41232014 647.74217627h191.54729318c19.60720323 0 34.68966726-15.08246403 34.68966729-34.68966727V134.93839925c0-16.59071043-13.57421762-30.16492806-30.16492808-30.16492805H617.57724821c-30.16492806 0-60.32985613 27.14843525-60.32985612 60.32985611v452.4739209c0 16.59071043 13.57421762 30.16492806 30.16492805 30.16492806z" fill="currentColor"></path>
</svg>
        <span>67</span>
      </div>
      <div class="count-box--item">
        <svg class="icon icon-categories" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
  <path d="M900.3614811 257.09082106h-339.81629553l-67.96326003-101.9448889c-19.41807444-29.12711113-48.54518557-43.69066667-82.52681443-43.69066667H123.6385189c-53.39970333 0-97.09036999 43.69066667-97.09037113 97.09036999v582.54222222c0 53.39970333 43.69066667 97.09036999 97.09037113 97.09037002h776.7229622c53.39970333 0 97.09036999-43.69066667 97.09037113-97.09037002V354.18119104c0-53.39970333-43.69066667-97.09036999-97.09037113-97.09036998z m-97.09036999 242.72592554H220.72888889c-24.27259221 0-48.54518557-24.27259221-48.54518556-48.54518556s24.27259221-48.54518557 48.54518556-48.54518444h582.54222222c24.27259221 0 48.54518557 24.27259221 48.54518556 48.54518444s-24.27259221 48.54518557-48.54518556 48.54518556z" fill="currentColor"></path>
</svg>
        11
      </div>
      <div class="count-box--item">
        <svg class="icon icon-tags" viewBox="0 0 1098 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
  <path d="M283.42180005 272q0-28.38857157-20.09142843-48.48000001t-48.47999998-20.09142842-48.48000002 20.09142842-20.09142846 48.48000001 20.09142846 48.48 48.48000002 20.09142843 48.47999998-20.09142843 20.09142843-48.48zM855.0332285 580.57142843q0 28.38857157-19.81714313 48.2057147l-263.03999997 263.58857157q-20.9142853 19.81714313-48.75428534 19.81714312-28.38857157 0-48.20571468-19.81714312l-383.04-383.58857157q-20.36571468-19.81714313-34.55999999-54.10285688t-14.19428534-62.6742853l0-222.85714313q0-27.84000002 20.36571469-48.20571469t48.2057147-20.36571466l222.85714313 0q28.38857157 0 62.6742853 14.19428529t54.65142842 34.55999999l383.04000001 382.49142843q19.81714313 20.9142853 19.81714314 48.75428532zM1060.74751475 580.57142843q0 28.38857157-19.81714313 48.2057147l-263.04 263.58857157q-20.9142853 19.81714313-48.75428531 19.81714312-19.26857155 0-31.61142843-7.47428531t-28.38857159-24.13714314l251.79428534-251.7942853q19.81714313-19.81714313 19.81714308-48.20571469 0-27.84000002-19.81714308-48.75428531l-383.04000001-382.49142845q-20.36571468-20.36571468-54.65142842-34.55999999t-62.67428532-14.19428534l120 0q28.38857157 0 62.67428532 14.19428534t54.65142842 34.55999999l383.03999998 382.49142845q19.81714313 20.9142853 19.81714314 48.75428531z" fill="currentColor"></path>
</svg>
        21
      </div>
    </div>
  </div>
</section>

      
<section class="widget-toc widget-item layout-margin content-padding--primary soft-size--large soft-style--box">
  <div class="widget-title">
    <svg class="icon icon-toc" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
  <path d="M134.50666666 767.46666668H460.8c27.73333333 0 50.24000001 22.50666668 50.24000001 50.23999999v50.13333333c0 27.73333333-22.50666668 50.24000001-50.24000001 50.24000001H134.50666666c-27.73333333 0-50.24000001-22.50666668-50.23999999-50.24000001v-50.13333333c0.10666668-27.73333333 22.50666668-50.24000001 50.24000001-50.24000001zM84.37333332 541.65333333h326.18666669c27.73333333 0 50.24000001 22.39999999 50.23999999 50.13333334v50.24000001c0 27.73333333-22.50666668 50.24000001-50.24000002 50.23999999H84.37333332c-27.73333333 0-50.24000001-22.50666668-50.23999999-50.23999999v-50.24000001c0-27.73333333 22.50666668-50.13333334 50.24000001-50.13333334zM134.50666666 315.83999999H460.8c27.73333333 0 50.24000001 22.50666668 50.24000001 50.24000001v50.24000001c0 27.73333333-22.50666668 50.13333334-50.24000001 50.13333333H134.50666666c-27.73333333 0-50.24000001-22.39999999-50.23999999-50.13333333v-50.24000001c0.10666668-27.84000001 22.50666668-50.24000001 50.24000001-50.23999999zM209.81333332 89.91999999h326.18666671c27.73333333 0 50.24000001 22.39999999 50.23999997 50.13333335v50.23999999c0 27.73333333-22.50666668 50.24000001-50.24000001 50.24000001H209.81333332c-27.73333333 0-50.24000001-22.50666668-50.23999999-50.24000001v-50.24000001c0-27.73333333 22.50666668-50.13333334 50.24000001-50.13333333zM692.05333333 623.36l274.66666669 176.00000002c23.36000001 14.93333333 30.08 45.97333334 15.14666666 69.33333332L954.77333334 910.93333333c-14.93333333 23.25333334-45.97333334 30.08-69.33333335 15.14666667l-274.66666666-176c-23.36000001-14.93333333-30.08-45.97333334-15.14666667-69.33333333l27.09333334-42.24000001c14.93333333-23.36000001 46.08000001-30.08 69.33333333-15.14666666z" fill="currentColor"></path>
</svg>
    <span>TOC</span>
  </div>
  <div class="widget-body">
    <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Handler%E6%9C%BA%E5%88%B6"><span class="toc-number">1.</span> <span class="toc-text">Handleræœºåˆ¶</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Handler%E6%98%AF%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E5%BB%B6%E6%97%B6%E6%B6%88%E6%81%AF%E7%9A%84%EF%BC%9F"><span class="toc-number">2.</span> <span class="toc-text">Handleræ˜¯å¦‚ä½•å®ç°å»¶æ—¶æ¶ˆæ¯çš„ï¼Ÿ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B3%E4%BA%8E-handler%EF%BC%8C%E5%9C%A8%E4%BB%BB%E4%BD%95%E5%9C%B0%E6%96%B9-new-handler-%E9%83%BD%E6%98%AF%E4%BB%80%E4%B9%88%E7%BA%BF%E7%A8%8B%E4%B8%8B"><span class="toc-number">3.</span> <span class="toc-text">å…³äº handlerï¼Œåœ¨ä»»ä½•åœ°æ–¹ new handler éƒ½æ˜¯ä»€ä¹ˆçº¿ç¨‹ä¸‹</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E5%9C%A8%E4%B8%BB%E7%BA%BF%E7%A8%8B%E5%8F%AF%E4%BB%A5%E7%9B%B4%E6%8E%A5%E4%BD%BF%E7%94%A8-Handler%EF%BC%9F"><span class="toc-number">4.</span> <span class="toc-text">ä¸ºä»€ä¹ˆåœ¨ä¸»çº¿ç¨‹å¯ä»¥ç›´æ¥ä½¿ç”¨ Handlerï¼Ÿ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Looper-%E5%AF%B9%E8%B1%A1%E6%98%AF%E5%A6%82%E4%BD%95%E7%BB%91%E5%AE%9A-MessageQueue-%E7%9A%84%EF%BC%9F"><span class="toc-number">5.</span> <span class="toc-text">Looper å¯¹è±¡æ˜¯å¦‚ä½•ç»‘å®š MessageQueue çš„ï¼Ÿ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Handler-%E5%A6%82%E4%BD%95%E7%BB%91%E5%AE%9A-MessageQueue%EF%BC%9F"><span class="toc-number">6.</span> <span class="toc-text">Handler å¦‚ä½•ç»‘å®š MessageQueueï¼Ÿ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#handler%E5%8F%91%E6%B6%88%E6%81%AF%E7%BB%99%E5%AD%90%E7%BA%BF%E7%A8%8B%EF%BC%8Clooper%E6%80%8E%E4%B9%88%E5%90%AF%E5%8A%A8%EF%BC%9F"><span class="toc-number">7.</span> <span class="toc-text">handlerå‘æ¶ˆæ¯ç»™å­çº¿ç¨‹ï¼Œlooperæ€ä¹ˆå¯åŠ¨ï¼Ÿ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#HandlerThread"><span class="toc-number">8.</span> <span class="toc-text">HandlerThread</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Looper"><span class="toc-number">9.</span> <span class="toc-text">Looper</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Android%E4%B8%AD%E4%B8%BA%E4%BB%80%E4%B9%88%E4%B8%BB%E7%BA%BF%E7%A8%8B%E4%B8%8D%E4%BC%9A%E5%9B%A0%E4%B8%BALooper-loop-%E9%87%8C%E7%9A%84%E6%AD%BB%E5%BE%AA%E7%8E%AF%E5%8D%A1%E6%AD%BB%EF%BC%9F"><span class="toc-number">10.</span> <span class="toc-text">Androidä¸­ä¸ºä»€ä¹ˆä¸»çº¿ç¨‹ä¸ä¼šå› ä¸ºLooper.loop()é‡Œçš„æ­»å¾ªç¯å¡æ­»ï¼Ÿ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Handler%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-number">11.</span> <span class="toc-text">Handlerå†…å­˜æ³„æ¼çš„é—®é¢˜</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3%EF%BC%9A"><span class="toc-number">11.1.</span> <span class="toc-text">è§£å†³ï¼š</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Handler-Native%E5%B1%82"><span class="toc-number">12.</span> <span class="toc-text">Handler (Nativeå±‚)</span></a></li></ol>
  </div>
</section>


      
<section class="widet-notice widget-item layout-margin content-padding--primary soft-size--large soft-style--box">
  <div class="widget-title">
    <svg class="icon icon-notice" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
  <path d="M512 945.02305225v28.15620663a24.27259221 24.27259221 0 0 1-24.27259221 24.27259335H394.0352a48.54518557 48.54518557 0 0 1-41.74885888-23.78714112l-110.68302222-184.47170332a132.04290333 132.04290333 0 0 1-17.47626667-48.54518557h118.4502511a200.97706667 200.97706667 0 0 1 76.21594113 14.56355556l20.38897777 133.49925888a48.54518557 48.54518557 0 0 0 36.40888888 27.67075555l16.01991111 2.91271112a24.27259221 24.27259221 0 0 1 20.38897778 25.72894889zM997.45185223 463.45481443a194.18074112 194.18074112 0 0 1-38.8361489 116.50844445 24.75804445 24.75804445 0 0 1-36.4088889 0l-34.95253333-34.95253333a24.27259221 24.27259221 0 0 1-2.91271111-30.58346667 97.09036999 97.09036999 0 0 0 0-106.79940665 24.27259221 24.27259221 0 0 1 2.91271111-30.58346666l34.95253333-34.95253334a24.75804445 24.75804445 0 0 1 18.93262223-7.28177777 26.2144 26.2144 0 0 1 17.47626667 9.70903665A194.18074112 194.18074112 0 0 1 997.45185223 463.45481443z m-194.18074112-388.36148111v776.72296335a48.54518557 48.54518557 0 0 1-48.54518556 48.54518443h-28.64165888a48.54518557 48.54518557 0 0 1-33.98163001-14.07810332l-145.63555556-143.20829668A291.27111111 291.27111111 0 0 0 342.57730333 657.63555556H172.18370333a145.63555556 145.63555556 0 0 1-145.63555556-145.63555556v-97.09036999a145.63555556 145.63555556 0 0 1 145.63555556-145.63555556h170.3936a291.27111111 291.27111111 0 0 0 206.31703779-85.43952668l145.63555555-143.20829554a48.54518557 48.54518557 0 0 1 33.98162888-14.07810446H754.72592555a48.54518557 48.54518557 0 0 1 48.54518556 48.54518555z" fill="currentColor"></path>
</svg>
    <span>NOTICE</span>
  </div>
  <div class="widget-body">
    <p>éº»ä¸­éº»</p>
  </div>
</section>


      <section class="widget-categorys widget-item layout-margin content-padding--primary soft-size--large soft-style--box">
  <div class="widget-title">
    <svg class="icon icon-categories" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
  <path d="M900.3614811 257.09082106h-339.81629553l-67.96326003-101.9448889c-19.41807444-29.12711113-48.54518557-43.69066667-82.52681443-43.69066667H123.6385189c-53.39970333 0-97.09036999 43.69066667-97.09037113 97.09036999v582.54222222c0 53.39970333 43.69066667 97.09036999 97.09037113 97.09037002h776.7229622c53.39970333 0 97.09036999-43.69066667 97.09037113-97.09037002V354.18119104c0-53.39970333-43.69066667-97.09036999-97.09037113-97.09036998z m-97.09036999 242.72592554H220.72888889c-24.27259221 0-48.54518557-24.27259221-48.54518556-48.54518556s24.27259221-48.54518557 48.54518556-48.54518444h582.54222222c24.27259221 0 48.54518557 24.27259221 48.54518556 48.54518444s-24.27259221 48.54518557-48.54518556 48.54518556z" fill="currentColor"></path>
</svg>
    <span>CATEGORYS</span>
  </div>
  <div class="widget-body">
    <ul class="categorys-list">
      
        <li class="categorys-list-item">
          <a href="/categories/%E7%AE%97%E6%B3%95/">
            ç®—æ³• (3)
          </a>
        </li>
      
        <li class="categorys-list-item">
          <a href="/categories/operation-system/">
            operation system (1)
          </a>
        </li>
      
        <li class="categorys-list-item">
          <a href="/categories/spring/">
            spring (1)
          </a>
        </li>
      
        <li class="categorys-list-item">
          <a href="/categories/%E6%97%A5%E5%B8%B8/">
            æ—¥å¸¸ (1)
          </a>
        </li>
      
        <li class="categorys-list-item">
          <a href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/">
            è®¡ç®—æœºç½‘ç»œ (7)
          </a>
        </li>
      
        <li class="categorys-list-item">
          <a href="/categories/IM/">
            IM (2)
          </a>
        </li>
      
        <li class="categorys-list-item">
          <a href="/categories/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/">
            æ“ä½œç³»ç»Ÿ (9)
          </a>
        </li>
      
        <li class="categorys-list-item">
          <a href="/categories/JAVA%E5%9F%BA%E7%A1%80/">
            JAVAåŸºç¡€ (11)
          </a>
        </li>
      
        <li class="categorys-list-item">
          <a href="/categories/Android%E5%9F%BA%E7%A1%80/">
            AndroidåŸºç¡€ (27)
          </a>
        </li>
      
        <li class="categorys-list-item">
          <a href="/categories/Kotlin%E5%9F%BA%E7%A1%80/">
            KotlinåŸºç¡€ (1)
          </a>
        </li>
      
        <li class="categorys-list-item">
          <a href="/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/">
            è®¾è®¡æ¨¡å¼ (1)
          </a>
        </li>
      
    </ul>
  </div>
</section>

      <section class="widget-tags widget-item  layout-margin content-padding--primary soft-size--large soft-style--box">
  <div class="widget-title">
    <svg class="icon icon-tags" viewBox="0 0 1098 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
  <path d="M283.42180005 272q0-28.38857157-20.09142843-48.48000001t-48.47999998-20.09142842-48.48000002 20.09142842-20.09142846 48.48000001 20.09142846 48.48 48.48000002 20.09142843 48.47999998-20.09142843 20.09142843-48.48zM855.0332285 580.57142843q0 28.38857157-19.81714313 48.2057147l-263.03999997 263.58857157q-20.9142853 19.81714313-48.75428534 19.81714312-28.38857157 0-48.20571468-19.81714312l-383.04-383.58857157q-20.36571468-19.81714313-34.55999999-54.10285688t-14.19428534-62.6742853l0-222.85714313q0-27.84000002 20.36571469-48.20571469t48.2057147-20.36571466l222.85714313 0q28.38857157 0 62.6742853 14.19428529t54.65142842 34.55999999l383.04000001 382.49142843q19.81714313 20.9142853 19.81714314 48.75428532zM1060.74751475 580.57142843q0 28.38857157-19.81714313 48.2057147l-263.04 263.58857157q-20.9142853 19.81714313-48.75428531 19.81714312-19.26857155 0-31.61142843-7.47428531t-28.38857159-24.13714314l251.79428534-251.7942853q19.81714313-19.81714313 19.81714308-48.20571469 0-27.84000002-19.81714308-48.75428531l-383.04000001-382.49142845q-20.36571468-20.36571468-54.65142842-34.55999999t-62.67428532-14.19428534l120 0q28.38857157 0 62.67428532 14.19428534t54.65142842 34.55999999l383.03999998 382.49142845q19.81714313 20.9142853 19.81714314 48.75428531z" fill="currentColor"></path>
</svg>
    <span>TAGS</span>
  </div>
  <div class="widget-body">
    <div class="tags-cloud">
      <a href="/tags/Activity/" style="font-size: 14px;" class="tags-cloud-4">Activity</a> <a href="/tags/Android%E5%9F%BA%E7%A1%80/" style="font-size: 20px;" class="tags-cloud-10">AndroidåŸºç¡€</a> <a href="/tags/Handler/" style="font-size: 10px;" class="tags-cloud-0">Handler</a> <a href="/tags/IM/" style="font-size: 12px;" class="tags-cloud-2">IM</a> <a href="/tags/JAVA%E5%9F%BA%E7%A1%80/" style="font-size: 18px;" class="tags-cloud-8">JAVAåŸºç¡€</a> <a href="/tags/JAVA%E5%A4%9A%E7%BA%BF%E7%A8%8B/" style="font-size: 10px;" class="tags-cloud-0">JAVAå¤šçº¿ç¨‹</a> <a href="/tags/JAVA%E5%B9%B6%E5%8F%91/" style="font-size: 12px;" class="tags-cloud-2">JAVAå¹¶å‘</a> <a href="/tags/JAVA%E9%9B%86%E5%90%88/" style="font-size: 10px;" class="tags-cloud-0">JAVAé›†åˆ</a> <a href="/tags/JVM/" style="font-size: 14px;" class="tags-cloud-4">JVM</a> <a href="/tags/Kotlin%E5%9F%BA%E7%A1%80/" style="font-size: 10px;" class="tags-cloud-0">KotlinåŸºç¡€</a> <a href="/tags/Service/" style="font-size: 10px;" class="tags-cloud-0">Service</a> <a href="/tags/TCP/" style="font-size: 12px;" class="tags-cloud-2">TCP</a> <a href="/tags/operation-system/" style="font-size: 10px;" class="tags-cloud-0">operation system</a> <a href="/tags/spring/" style="font-size: 10px;" class="tags-cloud-0">spring</a> <a href="/tags/%E2%80%98Flutter%E2%80%99/" style="font-size: 10px;" class="tags-cloud-0">â€˜Flutterâ€™</a> <a href="/tags/%E5%9B%9B%E5%A4%A7%E7%BB%84%E4%BB%B6/" style="font-size: 12px;" class="tags-cloud-2">å››å¤§ç»„ä»¶</a> <a href="/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/" style="font-size: 16px;" class="tags-cloud-6">æ“ä½œç³»ç»Ÿ</a> <a href="/tags/%E6%97%A5%E5%B8%B8/" style="font-size: 10px;" class="tags-cloud-0">æ—¥å¸¸</a> <a href="/tags/%E7%AE%97%E6%B3%95/" style="font-size: 14px;" class="tags-cloud-4">ç®—æ³•</a> <a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/" style="font-size: 16px;" class="tags-cloud-6">è®¡ç®—æœºç½‘ç»œ</a> <a href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" style="font-size: 10px;" class="tags-cloud-0">è®¾è®¡æ¨¡å¼</a>
    </div>
  </div>
</section>
    </div>
  </article>
</div>

    <!-- footer container -->
<footer id="footer" class="footer">
  <div class="footer-container">
    
    <div class="social-icons">
      
        
      
        
      
        
      
        
          <a href="https://github.com/asw675/" class="soft-size--primary soft-style--box" target="_blank" rel="noopener noreferrer">
            <svg class="icon icon-github" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
  <path d="M64.6 512c0 195.6 125.4 361.9 300.1 422.9 23.5 5.9 19.9-10.8 19.9-22.2v-77.6c-135.8 15.9-141.3-74-150.5-89-18.5-31.5-61.9-39.5-49-54.5 31-15.9 62.5 4 98.9 58 26.4 39.1 77.9 32.5 104.1 26 5.7-23.5 17.9-44.5 34.7-60.9-140.7-25.2-199.4-111.1-199.4-213.3 0-49.5 16.4-95.1 48.4-131.8-20.4-60.6 1.9-112.4 4.9-120.1 58.2-5.2 118.5 41.6 123.3 45.3 33.1-8.9 70.8-13.7 112.9-13.7 42.4 0 80.3 4.9 113.5 13.9 11.3-8.6 67.3-48.8 121.4-43.9 2.9 7.7 24.7 58.3 5.5 118.1 32.5 36.8 49 82.8 49 132.4 0 102.3-59 188.3-200.2 213.2 23.5 23.3 38.1 55.5 38.1 91.1v112.7c0.8 9 0 17.9 15.1 17.9C832.7 877 960.4 709.4 960.4 512.1c0-247.5-200.6-447.9-447.9-447.9C265 64.1 64.6 264.5 64.6 512z"></path>
</svg>
          </a>
        
      
        
      
    </div>
     
    <p>&copy; 2022 <a href="/" target="_blank">ReasonLee</a></p>

    

    <p>Powered by <a href="https://hexo.io" target="_blank" rel="noopener noreferrer">Hexo</a> Theme - <a href="https://github.com/miiiku/flex-block" target="_blank" rel="noopener noreferrer author">flex-block</a></p>

    <p>
      <a href="javascript:;" id="theme-light">ğŸŒ æµ…è‰²</a>
      <a href="javascript:;" id="theme-dark">ğŸŒ› æ·±è‰²</a>
      <a href="javascript:;" id="theme-auto">ğŸ¤–ï¸ è‡ªåŠ¨</a>
    </p>
  </div>
</footer>
  </div>

  <div class="back-to-top-fixed soft-size--round soft-style--box">
    <svg class="icon icon-back-to-top" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
      <path d="M725.333333 426.666667c-12.8 0-21.333333-4.266667-29.866667-12.8l-213.333333-213.333333c-17.066667-17.066667-17.066667-42.666667 0-59.733333s42.666667-17.066667 59.733333 0l213.333333 213.333333c17.066667 17.066667 17.066667 42.666667 0 59.733333C746.666667 422.4 738.133333 426.666667 725.333333 426.666667z"></path>
      <path d="M298.666667 426.666667c-12.8 0-21.333333-4.266667-29.866667-12.8-17.066667-17.066667-17.066667-42.666667 0-59.733333l213.333333-213.333333c17.066667-17.066667 42.666667-17.066667 59.733333 0s17.066667 42.666667 0 59.733333l-213.333333 213.333333C320 422.4 311.466667 426.666667 298.666667 426.666667z"></path>
      <path d="M512 896c-25.6 0-42.666667-17.066667-42.666667-42.666667L469.333333 170.666667c0-25.6 17.066667-42.666667 42.666667-42.666667s42.666667 17.066667 42.666667 42.666667l0 682.666667C554.666667 878.933333 537.6 896 512 896z"></path>
    </svg>
  </div>

  
  <!-- aplayer -->


<!-- dplayer -->




  


  


  




<script src="/js/script.js"></script>


  
  <!-- å°¾éƒ¨ç”¨æˆ·è‡ªå®šä¹‰ç›¸å…³å†…å®¹ -->
</body>
</html>